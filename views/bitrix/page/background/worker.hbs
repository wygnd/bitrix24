<script src="//api.bitrix24.com/api/v1/"></script>
<script>
  BX24.ready(function() {
    BX24.init(function() {
      BX24.placement.bindEvent('BackgroundCallCard::initialized', async (data) => {
        console.log(data);
        console.log(data.PHONE_NUMBER);

        const phone = encodeURIComponent(data.PHONE_NUMBER);
        const response = await fetch(`https://bitrix-grampus.ru/v1/widget/page/background/worker/data/call/initialized?phone=${phone}`)
          .then(res => res.json())
          .catch(err => {
            console.log(err);
            return {
              status: false,
              message: err.message,
            };
          });

        BX24.placement.call('CallCardSetStatusText', { statusText: response.message }, () => {
        });

      });

      // Событие перед закрытием карточки
      BX24.placement.bindEvent('CallCard::BeforeClose', function(callState) {
        console.log('Check call state, call card', callState);

        // Отключаем авто закрытие виджета после прерывания/окончания звонка
        BX24.placement.call('disableAutoClose', {}, function(result) {
          console.log('Check result disableAutoClose', result);
        });
      });

    });
  });
</script>